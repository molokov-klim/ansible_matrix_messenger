# Matrix Messenger Ansible Role

## Описание
Роль для установки и настройки приватного Matrix сервера для семейного использования.

## Архитектура решения
- **Core**: Matrix Synapse сервер
- **Прокси**: Nginx с автоматическим SSL (Let's Encrypt)
- **База данных**: PostgreSQL для хранения данных Matrix
- **Тестирование**: Molecule + Testinfra с Docker драйвером
- **CI/CD**: GitHub Actions для автоматического тестирования
- **Безопасность**: Переменные среды для секретов + простая валидация
- **Переменные среды**: Используются для конфигурации окружения и безопасного хранения чувствительных данных

## Требования
- Ubuntu 22.04 LTS
- Ansible 2.9+
- Доступ к серверу по SSH с правами sudo
- Доменное имя с настроенными DNS записями

## Переменные
### Обязательные переменные
```yaml
domain_name: "matrix.example.com"  # Ваше доменное имя
admin_email: "admin@example.com"   # Email для Let's Encrypt
```

### Чувствительные данные (хранить в .env)
```bash
ANSIBLE_HOST=192.168.1.100
ANSIBLE_USER=ubuntu
ANSIBLE_PASSWORD=твой_пароль_здесь
MATRIX_ADMIN_PASSWORD=придумай_надежный_пароль
POSTGRES_PASSWORD=еще_один_надежный_пароль
```

## Пример использования
```yaml
- hosts: matrix_servers
  roles:
    - matrix_messenger
```

## Установка

### Шаг 1: Подготовка конфигурационных файлов

1. Скопируйте `env.example` в `.env` и заполните своими значениями:
   ```bash
   cp env.example .env
   nano .env
   ```

2. Скопируйте `inventory.ini.example` в `inventory.ini` и укажите адрес вашего сервера:
   ```bash
   cp inventory.ini.example inventory.ini
   nano inventory.ini
   ```

### Шаг 2: Загрузите переменные окружения

```bash
source scripts/load_env.sh
```

Или используйте Makefile:
```bash
make load-env
```

### Шаг 3: Запустите установку

```bash
make deploy
```

Или напрямую через ansible-playbook:
```bash
ansible-playbook -i inventory.ini site.yml
```

## Безопасность
- Все чувствительные данные хранятся в .env файле (не коммитится)
- Публичная конфигурация хранится в git
- Автоматические проверки безопасности перед каждым запуском
- Публичная регистрация отключена по умолчанию
- Федерация ограничена только вашим доменом
- Автоматическое обновление SSL сертификатов

## Мониторинг
- Prometheus Node Exporter для мониторинга системы
- Включены метрики Synapse
- Fail2Ban для защиты от атак

## Резервное копирование
- Ежедневное резервное копирование базы данных
- Ежедневное резервное копирование конфигурации
- Автоматическая очистка старых резервных копий