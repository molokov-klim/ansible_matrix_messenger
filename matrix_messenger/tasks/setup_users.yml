---
# tasks/setup_users.yml
- name: Wait for Synapse service to be running
  systemd:
    name: matrix-synapse
    state: started
    daemon_reload: yes
  retries: 5
  delay: 10

- name: Wait for Synapse to be ready
  wait_for:
    host: localhost
    port: 8008
    delay: 30
    timeout: 300

- name: Create admin user
  command: >
    register_new_matrix_user
    -c /etc/matrix-synapse/homeserver.yaml
    -u admin
    -p {{ lookup('env', 'MATRIX_ADMIN_PASSWORD') | default('default_admin_password') }}
    --admin
  args:
    creates: "/var/lib/matrix-synapse/admin_created"
  register: admin_user_creation
  failed_when: admin_user_creation.rc != 0 and "already exists" not in admin_user_creation.stderr

- name: Create regular users
  command: >
    register_new_matrix_user
    -u {{ item.username }}
    -p {{ item.password }}
    http://localhost:8008
  loop: "{{ family_users | default([]) }}"
  when: item.password is defined
  args:
    creates: "/var/lib/matrix-synapse/{{ item.username }}_created"