---
# tasks/setup_users.yml
- name: Gather system information before connecting
  setup:
  register: system_facts

- name: Log system resources
  debug:
    msg: "System Info - Memory: {{ (system_facts.ansible_facts.ansible_memtotal_mb / 1024) | round(2) }} GB, CPU: {{ system_facts.ansible_facts.ansible_processor_vcpus }} cores"
  when: system_facts is defined

- name: Check system resources
  command: sh -c "df -h / | awk 'NR==2 {print $5}' | cut -d'%' -f1"
  register: disk_usage
  changed_when: false

- name: Check resource usage
  debug:
    msg: "Disk usage: {{ disk_usage.stdout }}%, Memory: {{ (system_facts.ansible_facts.ansible_memtotal_mb / 1024) | round(2) }} GB, CPU: {{ system_facts.ansible_facts.ansible_processor_vcpus }} cores"
  when: system_facts is defined

- name: Check Synapse service status
  systemd:
    name: matrix-synapse
    state: started
    daemon_reload: yes

- name: Wait for Synapse service to be running
  systemd:
    name: matrix-synapse
    state: started
    daemon_reload: yes
  retries: 5
  delay: 10

- name: Wait for Synapse to be ready
  uri:
    url: http://localhost:8008/_matrix/client/versions
    method: GET
    status_code: 200
    timeout: 60
  register: synapse_health
  retries: 20
  delay: 30
  until: synapse_health is succeeded or synapse_health.status == 200

- name: Check Synapse logs for errors
  command: journalctl -u matrix-synapse --no-pager --lines 20
  register: synapse_logs
  changed_when: false
  failed_when: false

- name: Display Synapse logs
  debug:
    var: synapse_logs.stdout_lines
  when: synapse_logs is defined

- name: Check if server_name.yaml exists in conf.d
  stat:
    path: /etc/matrix-synapse/conf.d/server_name.yaml
  register: server_name_file

- name: Create conf.d directory if missing
  file:
    path: /etc/matrix-synapse/conf.d
    state: directory
    owner: matrix-synapse
    group: matrix-synapse
    mode: '0755'

- name: Create server_name.yaml in conf.d if missing
  copy:
    content: |
      # This file contains the server name for Matrix Synapse
      # Generated automatically during setup
      server_name: "{{ domain_name }}"
    dest: /etc/matrix-synapse/conf.d/server_name.yaml
    owner: matrix-synapse
    group: matrix-synapse
    mode: '0644'
  when: not server_name_file.stat.exists

- name: Check if signing key exists
  stat:
    path: /etc/matrix-synapse/{{ domain_name }}.signing.key
  register: signing_key_file

- name: Generate signing key if missing
  command: python -m synapse.util.generate_signing_key /etc/matrix-synapse/{{ domain_name }}.signing.key
  args:
    creates: "/etc/matrix-synapse/{{ domain_name }}.signing.key"
  when: domain_name is defined and not signing_key_file.stat.exists
  register: signing_key_generation

- name: Set correct permissions for signing key
  file:
    path: /etc/matrix-synapse/{{ domain_name }}.signing.key
    owner: matrix-synapse
    group: matrix-synapse
    mode: '0600'
  when: domain_name is defined and signing_key_generation is defined and signing_key_generation.changed

- name: Restart Synapse if configuration files were created
  systemd:
    name: matrix-synapse
    state: restarted
  when: server_name_file.stat.exists == false or (signing_key_generation is defined and signing_key_generation.changed)

- name: Check PostgreSQL configuration in homeserver.yaml
  command: grep -i "database" /etc/matrix-synapse/homeserver.yaml
  register: db_config
  changed_when: false
  failed_when: false

- name: Display database configuration
  debug:
    var: db_config.stdout_lines
  when: db_config is defined and db_config.rc == 0

- name: Create admin user
  command: >
    register_new_matrix_user
    -c /etc/matrix-synapse/homeserver.yaml
    -u admin
    -p {{ lookup('env', 'MATRIX_ADMIN_PASSWORD') | default('default_admin_password') }}
    --admin
  args:
    creates: "/var/lib/matrix-synapse/admin_created"
  register: admin_user_creation
  failed_when: admin_user_creation.rc != 0 and "already exists" not in admin_user_creation.stderr

- name: Create regular users
  command: >
    register_new_matrix_user
    -u {{ item.username }}
    -p {{ item.password }}
    http://localhost:8008
  loop: "{{ family_users | default([]) }}"
  when: item.password is defined
  args:
    creates: "/var/lib/matrix-synapse/{{ item.username }}_created"