---
# tasks/setup_ssl.yml
- name: Install Certbot and Nginx plugin
  apt:
    name:
      - certbot
      - python3-certbot-nginx
    state: present

- name: Obtain SSL certificate
  command: >
    certbot --nginx --non-interactive --agree-tos
    --email {{ admin_email }}
    -d {{ domain_name }}
    --redirect
  args:
    creates: "/etc/letsencrypt/live/{{ domain_name }}/fullchain.pem"
  register: certbot_result
  failed_when: certbot_result.rc != 0 and "Certificate not yet due for renewal" not in certbot_result.stdout

- name: Create Certbot cron job for automatic renewal
  cron:
    name: "Renew SSL certificates"
    job: "/usr/bin/certbot renew --quiet --post-hook 'systemctl reload nginx'"
    minute: "0"
    hour: "3"
    day: "*"
    month: "*"
    weekday: "6"