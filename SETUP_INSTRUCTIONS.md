# Настройка Ansible проекта для Matrix Messenger

## Настройка на стороне сервера (Ubuntu 22.04)

### 1. Подготовка сервера

1. Убедитесь, что у вас есть пользователь с sudo привилегиями
2. Установите SSH-ключи для доступа к серверу (желательно не использовать парольную аутентификацию)

### 2. Генерация SSH-ключа на сервере

1. Подключитесь к серверу по SSH:
   ```bash
   ssh username@your_server_ip
   ```

2. Сгенерируйте SSH-ключ на сервере:
   ```bash
   ssh-keygen -t rsa -b 4096 -C "ansible@your_domain.com"
   ```
   
   При этом оставьте passphrase пустой, чтобы Ansible мог использовать ключ без ввода пароля

3. После генерации ключа, добавьте публичный ключ в authorized_keys:
   ```bash
   cat ~/.ssh/id_rsa.pub >> ~/.ssh/authorized_keys
   ```

4. Установите правильные права доступа:
   ```bash
   chmod 700 ~/.ssh
   chmod 600 ~/.ssh/id_rsa
   chmod 600 ~/.ssh/id_rsa.pub
   chmod 600 ~/.ssh/authorized_keys
   ```

5. Скопируйте содержимое приватного ключа:
   ```bash
   cat ~/.ssh/id_rsa
   ```
   
   Это содержимое понадобится для настройки GitHub Actions

### 3. Настройка доступа для Ansible

1. Убедитесь, что пользователь, от имени которого будет работать Ansible, имеет права sudo:
   ```bash
   sudo usermod -aG sudo ansible_user
   ```

2. Проверьте, что SSH-доступ работает:
   ```bash
   # Проверьте, что вы можете подключиться к серверу с самого себя
   ssh -i ~/.ssh/id_rsa username@localhost
   ```

## Настройка переменных среды для CI/CD

### Для GitHub Actions (CI/CD)

1. В настройках вашего GitHub репозитория добавьте следующие секреты:

- `SERVER_IP`: IP-адрес вашего сервера
- `ANSIBLE_USER`: Имя пользователя на сервере
- `SSH_PRIVATE_KEY`: Приватный SSH-ключ, сгенерированный на сервере (содержимое файла ~/.ssh/id_rsa)
- `DB_PASSWORD`: Пароль для базы данных (если используется)

ВАЖНО: Не используйте локальный запуск плейбуков, все операции должны выполняться исключительно через CI/CD pipeline.

## Запуск Ansible плейбука через CI/CD

### GitHub Actions

1. Убедитесь, что все секреты настроены в репозитории GitHub

2. Запуск происходит автоматически при пуше в ветку main

3. Для ручного запуска перейдите в раздел Actions в репозитории GitHub и запустите workflow вручную

ВАЖНО: Все запуски плейбуков должны происходить исключительно через CI/CD pipeline, локальный запуск не предусмотрен.

## Решение типичных проблем

### Проблема: "The ssh-private-key argument is empty"
**Решение**: Убедитесь, что вы добавили секрет SSH_PRIVATE_KEY в настройках репозитория GitHub:
1. Перейдите в Settings репозитория
2. Выберите Secrets and variables → Actions
3. Добавьте новый Secret с именем `SSH_PRIVATE_KEY` и значением содержимого вашего приватного SSH-ключа

### Проблема: Ошибки совместимости Ansible
Если вы сталкиваетесь с ошибками типа `AttributeError: module 'os' has no attribute 'get_blocking'`, это может быть связано с несовместимостью между 32-битной версией Python и новыми версиями Ansible. В таком случае:
1. Используйте 64-битную версию Python
2. Или установите более старую, но совместимую версию Ansible

### Проблема: Ошибка доступа к серверу
Убедитесь, что:
1. SSH-ключ правильно скопирован на сервер
2. Права доступа к SSH-ключу корректны (обычно 600)
3. Пользователь на сервере имеет права sudo (если требуется выполнение задач с правами суперпользователя)

## Безопасность

1. Никогда не коммитьте чувствительные данные в репозиторий
2. Используйте только переменные среды или Ansible Vault для хранения паролей и других конфиденциальных данных
3. Проверяйте файл .gitignore, чтобы убедиться, что конфиденциальные файлы не попадают в репозиторий