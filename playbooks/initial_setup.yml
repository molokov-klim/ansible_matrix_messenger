---
# Ansible Playbook for Initial Server Setup on Ubuntu 22.04

- name: Initial server setup for Ubuntu 22.04
  hosts: ubuntu_servers
  become: yes
  vars:
    # Load variables from environment variables
    db_user: "{{ lookup('env', 'DB_USER') | default('postgres') }}"
    db_password: "{{ lookup('env', 'DB_PASSWORD') | default('') }}"
    db_host: "{{ lookup('env', 'DB_HOST') | default('localhost') }}"
    db_name: "{{ lookup('env', 'DB_NAME') | default('') }}"

  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
      register: apt_update_result

    - name: Handle apt update failure (Ubuntu specific)
      debug:
        msg: "Note: Sometimes apt update fails due to minor hash mismatches, continuing anyway"
      when: apt_update_result is failed

    - name: Upgrade all packages to the latest version
      apt:
        upgrade: dist
        force_apt_get: yes

    - name: Install required packages
      apt:
        name:
          - net-tools
          - python3-dev
          - python3-pip
          - libpq-dev
          - mc
          - aptitude
          - htop
          - apache2-utils
          - lsb-release
          - wget
          - apt-transport-https
        state: present
        update_cache: yes

    - name: Install psycopg2 via pip
      pip:
        name: psycopg2
        executable: pip3